
---
title: "Analyzing the results of RHSP" 
author: "Michael Koch"
date: "07-03-2022"
output: html_document
---

# Working through the results of the Mini- (/ Pilot-) simulation for the RHSP

Note, I'm working in the Thesis folder for now to avoid merge conflicts and just overall github gezeik. 

# Step1: Prepearations

```{r, message = F, warning = F}
# load packages outside of simulation
library(papaja)
#source required functions & parameters
source('~/OneDrive/ms/thesis/R/functions.R')
source('~/OneDrive/ms/thesis/R/parameters.R')
```

```{r}
# load results
resultsRHSP <- read.csv("~/OneDrive/ms/thesis/output/resultsRHSP.csv", 
                        sep = " ", 
                        header = TRUE)
convRHSP <- read.csv("~/OneDrive/ms/thesis/output/convRHSP.csv",
                     sep = " ",
                     header = TRUE)
```
Let's, again, recompute the biases of the cross-loadings

```{r}
resultsRHSP <- 
  resultsRHSP %>% 
  mutate(biasCrossMean_1 = abs(crossEstMean_1 - cross),
         biasCrossMean_6 = abs(crossEstMean_6 - cross)) 
```

```{r, chache=T}
# inspect a bit
nrow(resultsRHSP)
```

```{r}
(nrow(condPop)*nrow(condRHSP)*nIter) - nrow(resultsRHSP)
```

122 chains failed, which is in correspondence with the error R gave. Let 's find out the positions of those that failed. Perhaps they can be re-run. If they cannot, this may also be a result. 

```{r}
comp <- 1:76800
failedChainIndex <- which((comp %in% resultsRHSP$pos) == FALSE)
length(failedChainIndex)
failedChainIndex
```

Het zijn er allemaal positions uit de eerste 200 iteraties

Let's check, which setup of conditions these positions correspond to. 

```{r}
# read in data
load("/home/michi/OneDrive/ms/thesis/data/data/datasets.Rds")
datStanRHSP <- prepareDat(datasets, condRHSP, nIter)
```


```{r}
# subset datasets with the positions
failedChains <- list()
condFailedChains <- data.frame()
for (i in 1:length(failedChainIndex)){
  failedChains[[i]] <- datStanRHSP[[failedChainIndex[i]]]
  condFailedChainsCurr <- data.frame(N = failedChains[[i]]$N,
                                      cross = failedChains[[i]]$cross,
                                      iter = failedChains[[i]]$iter,
                                      scaleGlobal = failedChains[[i]]$scaleGlobal,
                                      scaleLocal = failedChains[[i]]$scaleLocal,
                                      dfGlobal = failedChains[[i]]$dfGlobal,
                                      dfLocal = failedChains[[i]]$dfLocal,
                                      nu = failedChains[[i]]$nu,
                                      scaleSlab = failedChains[[i]]$scaleSlab
  )
  condFailedChains <- rbind(condFailedChains, condFailedChainsCurr)
}
```

```{r}
condFailedChains
```



# Post-process

Arrange the data based on conditions and iteration, and add a sigma squared column:


```{r}
resultsRHSP <- 
  resultsRHSP %>% 
  arrange(scaleGlobal, scaleLocal, dfGlobal, dfLocal, nu, scaleSlab, N, cross, iteration) 
```

## Convergence

Let's explore the convergence a bit

```{r}

```


### Divergent transitions

Not a single divergent transition

```{r}
totalSumDiv <- sum(convRHSP$sumDiv)
```

Heel erg veel.

-per iteratie percentage berekenen, later middelen over condities

FF wat tabelletjes maken van onder welke condities

### Effective Sample Size

```{r}
convRHSP %>% 
  filter(parameter == "n_eff") %>% 
  map_df(mean)
```

bayesplot-package vignette cut-offs ratio effective samp size total samp size. 

Not a single parameter with a MINIMUM effective sample size of smaller than ...

### R-Hat

```{r}
convRHSP %>% 
  filter(parameter == "Rhat") %>% 
  map_df(max) %>% 
  map_df(function(x){x < 1.01})
```

Not a single parameter where the MAXIMUM Rhat IS NOT < 1.005


### Max Treedepth

```{r}
convRHSP %>% 
  filter(parameter == "Rhat") %>% 
  select(maxTree) %>% 
  map_df(max) 
```

FF met Sara bespreken, maar dit is meer over efficientie dan validiteit van de output, dus het zit sws wel goed!!!


## Compute Relative Bias

First I subset all mean estimates 

```{r}
MeanEst <- 
 resultsRHSP %>% 
  select(mainEstMean_1:mainEstMean_6,
        crossEstMean_1:crossEstMean_6,
        thetaEstMean_1:thetaEstMean_6,
        factCorrEstMean,
        cross) # also subset the true cross Loading
```

Next all median estimates
```{r}
MedEst <- 
 resultsRHSP %>% 
  select(mainEstMed_1:mainEstMed_6,
        crossEstMed_1:crossEstMed_6,
        thetaEstMed_1:thetaEstMed_6,
        factCorrEstMed, 
        cross) # also subset the true cross Loading
```


```{r}
# write function to compute relative bias
# Input: relevant subset of data & modelPars
relativeBias <- function(subsetEst, modelPars){
  
  # helper function
  computeRelBias <- function(est, true){
    
  }
  
  # make object of true estimates that matches estimates
  main <- rep(modelPars$main[, )
  
  if(subsetEst$cross)
  
  #  helper function to whole subset
  
  
  # return output
  return()
  
}

# call function on whole subsets
# relativeBiasMean <- relativeBias(MeanEst)
# relativeBiasMed <- relativeBias(MedEst)
```


## Compute MSE

```{r}
# write function to compute MSE
# Input: relevant subset of data & modelPars
mse <- function(subsetEst, modelPars){

    # make a dataset you can just 
    main <- subsetEst[, 1:6]
    cross <- subsetEst[, 7:12]
    theta <- subsetEst[, 13:18]
    factCorr <- subsetEst[, 19]
    trues <- cbind(main, cross, theta, factCorr)
    
    # compute mse
    mse <
    
  
}  
# call function on whole subsets
# mseMean <- mse(MeanEst)
# mseMed <-  mse(MedEst)
```

## Compute Power (for truly non-zero cross-loadings)

First, subset the relevant variables

```{r}

```


## Compute Type-I error rate (for truly zero cross-loadings)

First, subset the relevant variables

```{r}

```



# Tabels

- One huge-ass table with ALL results?

## Bias Mean Estimates

### Factor Correlation

```{r}
t1 <- 
resultsRHSP %>% 
  select(biasFactCorrMean, cross) %>%
  group_by(cross) %>% 
  summarise(`Mean Bias in Mean Estimates Factor Correlation` = mean(biasFactCorrMean))
```


```{r}
t1
```





# Plots


## Bias Mean Estimates 

### Cross-Loadings

```{r}
resultsRHSP %>% 
  select(biasCrossMean_1:biasCrossMean_6, cross) %>%
  group_by(as.factor(cross)) %>% 
  summarise(meanBiasCrossMean_x = mean(biasCrossMean_1)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasCrossMean_x))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean Bias",
       title = "Mean (pooled) Bias in Mean Estimates Cross Loadings" )
```

### Factor Correlation

```{r}
resultsRHSP %>% 
  select(biasFactCorrMean, cross) %>%
  group_by(cross) %>% 
  summarise(meanBiasFactCorrMean = mean(biasFactCorrMean)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasFactCorrMean))+
  geom_point(shape = 3)+
  papaja::theme_apa()+
  labs(x = "Size Cross Loadings",
       y = "Mean Absolute Bias",
       title = "Mean Absolute Bias in Mean Estimates Factor Correlation")
```

```{r, warning = F}
resultsRHSP %>% 
  select(biasFactCorrMean, cross, sigmaSqu) %>%
  mutate(label = as.factor(paste0("\u03c3\u00B2 = ", sigmaSqu))) %>% 
  group_by(cross, label) %>% 
  summarise(meanBiasFactCorrMean = mean(biasFactCorrMean,)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasFactCorrMean))+
  geom_point(shape = 3)+
  facet_wrap(~label)+
  labs(x = "Size Cross Loading",
       y = "Mean Absolute Bias",
      title = "Mean Absolute Bias in Mean Estimates Factor Correlation")+
  theme_apa()
```


### Main Loadings

```{r}
resultsRHSP %>% 
  select(biasMainMean_1:biasMainMean_6, cross) %>%
  #mutate(biasMainMeanPooled = (biasMainMean_1+biasMainMean_2+biasMainMean_3+biasMainMean_4+biasMainMean_5+biasMainMean_6)/6) %>% 
  group_by(as.factor(cross)) %>% 
  summarise(meanBiasMain_x = mean(biasMainMean_4)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasMain_x))+
  geom_point(shape = 3)+
  papaja::theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean Bias",
       title = "Mean  Bias in Mean Estimates Main Loading ..." )
```




## Bias Median Estimates

### Factor Correlation

```{r}
outcomes %>% 
  select(biasFactCorrMed, cross) %>%
  group_by(cross) %>% 
  summarise(meanBiasFactCorrMed = mean(biasFactCorrMed)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasFactCorrMed))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loadings",
       y = "Mean Bias",
       title = "Mean Bias in Median Estimates Factor Correlation")
```

```{r}
outcomes %>% 
  select(biasFactCorrMed, cross, sigmaSqu) %>%
  mutate(label = as.factor(paste0("\u03c3\u00B2 = ", sigmaSqu))) %>% 
  group_by(cross, label) %>% 
  summarise(meanBiasFactCorrMed = mean(biasFactCorrMed)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasFactCorrMed))+
  geom_point(shape = 3)+
  facet_wrap(~label)+
  labs(x = "Size Cross Loading",
       y = "Mean Bias",
      title = "Mean Bias in Median Estimates Factor Correlation")+
  theme_apa()
```

### Main Loadings

```{r}
outcomes %>% 
  select(biasMainMed_1:biasMainMed_6, cross) %>%
  mutate(biasMainMedPooled = (biasMainMed_1+biasMainMed_2+biasMainMed_3+biasMainMed_4+biasMainMed_5+biasMainMed_6)/6) %>% 
  group_by(as.factor(cross)) %>% 
  summarise(meanBiasMainMedPooled = mean(biasMainMedPooled)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasMainMedPooled))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean Bias",
       title = "Mean (pooled) Bias in Median Estimates Main Loadings" )
```


### Cross-Loadings

```{r}
outcomes %>% 
  select(biasCrossMed_1:biasCrossMed_6, cross) %>%
  mutate(biasCrossMedPooled = (biasCrossMed_1 + biasCrossMed_2+biasCrossMed_3+biasCrossMed_4+biasCrossMed_5+biasCrossMed_6)/6) %>% 
  group_by(as.factor(cross)) %>% 
  summarise(meanBiasCrossMedPooled = mean(biasCrossMedPooled)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanBiasCrossMedPooled))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean Bias",
       title = "Mean (pooled) Bias in Median Estimates Cross Loadings" )
```



## MSE Mean Estimates

### Factor Correlation

```{r}
outcomes %>% 
  select(mseFactCorrMean, cross) %>%
  group_by(cross) %>% 
  summarise(meanMSEFactCorrMean = mean(mseFactCorrMean)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSEFactCorrMean))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loadings",
       y = "Mean MSE",
       title = "Mean MSE in Mean Estimates Factor Correlation")
```
```{r}
outcomes %>% 
  select(mseFactCorrMean, cross, sigmaSqu) %>%
  mutate(label = as.factor(paste0("\u03c3\u00B2 = ", sigmaSqu))) %>% 
  group_by(cross, label) %>% 
  summarise(meanMSEFactCorrMean = mean(mseFactCorrMean)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSEFactCorrMean))+
  geom_point(shape = 3)+
  facet_wrap(~label)+
  labs(x = "Size Cross Loading",
       y = "Mean MSE",
      title = "Mean MSE in Mean Estimates Factor Correlation")+
  theme_apa()
```


### Main Loadings

```{r}
outcomes %>% 
  select(mseMainMean_1:mseMainMean_6, cross) %>%
  mutate(mseMainMeanPooled = (mseMainMean_1+mseMainMean_2+mseMainMean_3+mseMainMean_4+mseMainMean_5+mseMainMean_6)/6) %>% 
  group_by(as.factor(cross)) %>% 
  summarise(meanMSEMainMeanPooled = mean(mseMainMeanPooled)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSEMainMeanPooled))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean MSE",
       title = "Mean (pooled) Bias MSE in Mean Estimates Main Loadings" )
```

### Cross-Loadings

```{r}
outcomes %>% 
  select(mseCrossMean_1:mseCrossMean_6, cross) %>%
  mutate(mseCrossMeanPooled = (mseCrossMean_1 + mseCrossMean_2 + mseCrossMean_3+mseCrossMean_4+mseCrossMean_5+mseCrossMean_6)/6) %>% 
  group_by(as.factor(cross)) %>% 
  summarise(meanMSECrossMeanPooled = mean(mseCrossMeanPooled)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSECrossMeanPooled))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean MSE",
       title = "Mean (pooled) MSE in Mean Estimates Cross Loadings" )
```


## MSE Median Estimates

### Factor Correlation

```{r}
outcomes %>% 
  select(mseFactCorrMed, cross) %>%
  group_by(cross) %>% 
  summarise(meanMSEFactCorrMed = mean(mseFactCorrMed)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSEFactCorrMed))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loadings",
       y = "Mean MSE",
       title = "Mean MSE in Median Estimates Factor Correlation")
```
```{r}
outcomes %>% 
  select(mseFactCorrMed, cross, sigmaSqu) %>%
  mutate(label = as.factor(paste0("\u03c3\u00B2 = ", sigmaSqu))) %>% 
  group_by(cross, label) %>% 
  summarise(meanMSEFactCorrMed = mean(mseFactCorrMed)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSEFactCorrMed))+
  geom_point(shape = 3)+
  facet_wrap(~label)+
  labs(x = "Size Cross Loading",
       y = "Mean MSE",
      title = "Mean MSE in Median Estimates Factor Correlation")+
  theme_apa()
```


### Main Loadings

```{r}
outcomes %>% 
  select(mseMainMed_1:mseMainMed_6, cross) %>%
  mutate(mseMainMedPooled = (mseMainMed_1+mseMainMed_2+mseMainMed_3+mseMainMed_4+mseMainMed_5+mseMainMed_6)/6) %>% 
  group_by(as.factor(cross)) %>% 
  summarise(meanMSEMainMedPooled = mean(mseMainMedPooled)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSEMainMedPooled))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean MSE",
       title = "Mean (pooled) Bias MSE in Median Estimates Main Loadings" )
```


### Cross-Loadings

```{r}
outcomes %>% 
  select(mseCrossMed_1:mseCrossMed_6, cross) %>%
  mutate(mseCrossMedPooled = (mseCrossMed_1 + mseCrossMed_2 + mseCrossMed_3+mseCrossMed_4+mseCrossMed_5+mseCrossMed_6)/6) %>% 
  group_by(as.factor(cross)) %>% 
  summarise(meanMSECrossMedPooled = mean(mseCrossMedPooled)) %>% 
  ggplot(aes(x = as.factor(cross), y = meanMSECrossMedPooled))+
  geom_point(shape = 3)+
  theme_apa()+
  labs(x = "Size Cross Loading",
       y = "Pooled Mean MSE",
       title = "Mean (pooled) MSE in Median Estimates Cross Loadings" )
```



# Quantile Plots

```{r}
quantilesWide <- select(resultsRHSP, X2.5._1:X90._6)
quantilesLong <- 
  intervalsWide %>% 
  pivot_longer(everything(), 
               names_to = c("quantile", "item"),
               names_sep = "_")
```

```{r}
#quantilesLong %>% 
#  group_by(item) %>% 
#  select()
#  filter(c(X2.5.))
```

