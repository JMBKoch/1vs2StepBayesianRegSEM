
---
title: "Analyzing the results of RHSP" 
author: "Michael Koch"
date: "07-03-2022"
output: html_document
---


# Step1: Prepearations

```{r, message = F, warning = F}
# load packages outside of simulation
library(papaja)
#source required functions & parameters
source('~/1vs2StepBayesianRegSEM/R/functions.R')
source('~/1vs2StepBayesianRegSEM/R/parameters.R')
```

```{r, cache = T}
# load results
resultsRHSP <- read.csv("~/OneDrive/ms/thesis/output/resultsRHSP.csv", 
                        sep = " ", 
                        header = TRUE)
convRHSP <- read.csv("~/OneDrive/ms/thesis/output/convRHSP.csv",
                     sep = " ",
                     header = TRUE)
```

# Post-process

```{r}
resultsRHSP <- 
  resultsRHSP %>% 
  arrange(scaleGlobal, dfGlobal, scaleLocal, dfLocal, scaleSlab, nu, N, cross, iteration) %>% 
  mutate(biasCrossMean_1 = abs(crossEstMean_1 - cross),
         biasCrossMean_2 = abs(crossEstMean_2 - 0),
         biasCrossMean_3 = abs(crossEstMean_3 - 0),
         biasCrossMean_4 = abs(crossEstMean_4 - 0),
         biasCrossMean_5 = abs(crossEstMean_5 - 0),
         biasCrossMean_6 = abs(crossEstMean_6 - cross)
) 
  
```

```{r}
# inspect a bit
nrow(resultsRHSP)
```

```{r}
(nrow(condPop)*nrow(condRHSP)*nIter) - nrow(resultsRHSP)
```

122 chains failed, which is in correspondence with the error R gave. Let 's find out the positions of those that failed. Perhaps they can be re-run. If they cannot, this may also be a result. 

```{r}
comp <- 1:76800
failedChainIndex <- which((comp %in% resultsRHSP$pos) == FALSE)
length(failedChainIndex)
failedChainIndex
```

These indicices are all from the first 200 iterations. We can simply find the set of conditions belong to thi sby subsetting the first row of results

```{r}
resultsRHSP %>% 
  select(scaleGlobal, dfGlobal, scaleLocal, dfLocal, scaleSlab, nu, N, cross, iteration) %>%
  head(1)
```


Thus, with N = 100, cross = 0.2 and the hyper-parameters all on their lowest vaslue (0.1 for scales, and 1 for df's) the chains don't converge in the majority of the cases.

Let's check the convergence diagnostics for those few replications under these conditions that did yield any output at all. We can assume that the convergence diagnostics do not not look good here

```{r}
convRHSP %>% 
  filter(pos <= 200) %>% 
  arrange(pos)
```

These are 156 rows, hence the 200-122 = 78 (times too because of the output format) chains under the first set of conditions that did not fail. Interestingly, the chains that did not fail show good convergence, which is sort of puzzling, but maybe not?

I will however, remove them from the analysis, as there are too few iterations for a reliable picture of this set of conditions (Discuss with Sara). 

```{r}
resultsRHSP <- 
  resultsRHSP %>% 
  filter(pos > 200)
```

```{r}
convRHSO <- 
  resultsRHSP %>% 
  filter(pos > 200)
```


# Convergence

Let's explore the convergence a bit (of the remaining set of conditions).

## Divergent transitions

```{r}
totalSumDiv <- sum(convRHSP$sumDiv)
totalSumDiv
totalSumDiv / (2000*nrow(convRHSP))
```

In total, there are a gazillion divergent transition, but only a fraction of all transitions were divergent. Let's start by computing the percentage per individual replication. And then we can check how big that is on average per set of conditions.

```{r}
meanPercDiv <- 
convRHSP %>% 
  filter(parameter == "Rhat") %>% # doesn't matter which you pick here
  mutate(percDiv = sumDiv/ samplePars$nSampling) %>% 
  group_by(scaleGlobal, dfGlobal, scaleLocal, dfLocal, scaleSlab, nu, N, cross) %>%
  summarise(meanPercDiv = mean(percDiv)*100)
meanPercDiv
```

## Effective Sample Size

```{r}
convRHSP %>% 
  filter(parameter == "n_eff") %>% 
  group_by(scaleGlobal, dfGlobal, scaleLocal, dfLocal, scaleSlab, nu, N, cross) %>%
  #map_df(as.numeric) %>% 
  select(scaleGlobal, dfGlobal, scaleLocal, dfLocal, scaleSlab, nu, N, cross, lambdaMainC.1.:theta.6.) %>% 
  
  summarise_all(mean)
```


### R-Hat

```{r}
convRHSP %>% 
  filter(parameter == "Rhat") %>% 
  map_df(max) %>% 
  map_df(function(x){x < 1.01})
```

Not a single parameter where the MAXIMUM Rhat IS NOT < 1.005


# Post-process

Arrange the data based on conditions and iteration, and add a sigma squared column:


```{r}
resultsRHSP <- 
  resultsRHSP %>% 
  arrange(scaleGlobal, scaleLocal, dfGlobal, dfLocal, nu, scaleSlab, N, cross, iteration)     mutate(biasCrossMean_1 =     abs(crossEstMean_1 - cross),
         biasCrossMean_2 = abs(crossEstMean_2 - 0),
         biasCrossMean_3 = abs(crossEstMean_3 - 0),
         biasCrossMean_4 = abs(crossEstMean_4 - 0),
         biasCrossMean_5 = abs(crossEstMean_5 - 0),
         biasCrossMean_6 = abs(crossEstMean_6 - cross))
```